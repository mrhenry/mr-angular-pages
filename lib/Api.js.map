{"version":3,"sources":["../src/Api.js"],"names":[],"mappings":"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","file":"Api.js","sourcesContent":["import {beforeBoot} from 'fd-angular-core';\n\nlet summariesPromise;\n\nbeforeBoot(fetchSummaries());\n\nexport function fetchSummaries() {\n  if (summariesPromise) return summariesPromise;\n  summariesPromise = fetch(\"/api/pages.json\")\n    .then(status)\n    .then(json)\n    .then(makeTree);\n  return summariesPromise;\n}\n\nfunction status(resp) {\n  if (!resp.status === 200) {\n    throw Error(`Unexpected response status: ${resp.status}`);\n  }\n  return resp;\n}\n\nfunction json(resp) {\n  return resp.json();\n}\n\nfunction makeTree(data) {\n  let pages = (data.pages || []);\n  let pagesById = {};\n  let pagesByPath = {};\n  let roots = [];\n\n  if (navigator.language) {\n    let locale = navigator.language.split('-')[0];\n    if (!data.i18n.locales.indexOf(locale)) {\n      locale = data.i18n.default;\n    }\n    data.i18n.current = locale;\n  }\n\n  // localize\n  let lpages = [];\n  for (let locale of data.i18n.locales) {\n    for (let page of pages) {\n      _page = Object.create(page, {});\n      _page.translations = undefined;\n      _page.id = `${locale}/${page.id}`;\n\n      let translations;\n      for (let t of page.translations) {\n        if (t.locale == locale) {\n          translations = t;\n          break;\n        }\n        if (t.locale == data.i18n.default) {\n          translations = t;\n        }\n      }\n      for (let key of Object.keys(translations)) {\n        _page[key] = translations[key];\n      }\n      _page.locale = locale;\n\n      if (page.parent_id) {\n        _page.parent_id = `${locale}/${page.parent_id}`;\n      }\n\n      pagesById[_page.id] = _page;\n      lpages.push(_page);\n    }\n  }\n  pages = lpages;\n\n  // resolve parent pages\n  for (let page of pages) {\n    if (page.parent_id) {\n      let parent = pagesById[page.parent_id];\n      if (!parent.child_ids) parent.child_ids = [];\n      parent.child_ids.push(page.id);\n      page.parent = parent;\n    } else {\n      roots.push(page);\n    }\n  }\n  roots.sort(positionSort);\n\n  // resolve child pages\n  for (let page of pages) {\n    if (page.child_ids) {\n      let children = [];\n      for (let id of page.child_ids) {\n        let child = pagesById[id];\n        if (child) children.push(child);\n      }\n      children.sort(positionSort);\n      page.children = children;\n    } else {\n      page.children = [];\n    }\n  }\n\n  // map by path\n  for (let page of roots) {\n    makePath(page, `/${page.locale}`, pagesByPath);\n    if (page.locale === data.i18n.current) {\n      makePath(page, `/`, pagesByPath);\n    }\n  }\n\n  return {\n    types: data.types,\n    i18n:  data.i18n,\n    pages: pagesByPath,\n  };\n\n  function makePath(page, prefix, acc, root) {\n    let path = page.path_component == '' ? prefix :\n               prefix == '/'             ? `/${page.path_component}` :\n               `${prefix}/${page.path_component}`;\n\n    if (!root) root = page;\n\n    page.root = root;\n    page.path = path;\n    acc[path] = page;\n\n    for (let child of page.children) {\n      makePath(child, path, acc, root);\n    }\n  }\n\n  function positionSort(a, b) {\n    let posa = (a.position || 0);\n    let posb = (b.position || 0);\n    return posa - posb;\n  }\n}\n"]}